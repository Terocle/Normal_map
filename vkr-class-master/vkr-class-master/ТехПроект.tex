\section{Технический проект}
\subsection{Общая характеристика организации решения задачи}

Разрабатываемая программно-информационная система представляет собой настольное приложение, ориентированное на выполнение двух основных функций: генерацию карт нормалей по 2D-изображениям и интерактивную визуализацию этих карт в контексте имитации освещения. Цель системы — предоставить пользователю удобный и гибкий инструмент для анализа текстур и их освещённых свойств, применимых в игровой разработке и визуализации \cite{tidwell2020}.

Особенностью разрабатываемой системы является её полная автономность: для использования программы не требуется подключение к сети Интернет, установка дополнительных серверов или сторонних сервисов. Все вычисления выполняются локально, на стороне клиента, что обеспечивает высокую скорость обработки и независимость от внешних факторов. Это особенно важно для использования инструмента в офлайн-среде, при разработке игр, создании ассетов или экспериментировании с визуальными эффектами.

Архитектура приложения построена по модульному принципу, что обеспечивает независимость компонентов, удобство расширения и тестирования, а также простоту поддержки. Вся логика работы разделена на два ключевых функциональных блока:

\begin{enumerate}
	\item Модуль генерации карт нормалей. Этот компонент отвечает за обработку загруженного 2D-изображения и построение карты нормалей с помощью градиентного анализа. Пользователь может выбрать один из трёх алгоритмов: Sobel, Scharr или Prewitt. Каждый из них позволяет выявлять локальные изменения яркости изображения и формировать на их основе вектор нормали. В дополнение к алгоритму доступны параметры настройки: сила нормалей, глубина, инверсия. Все изменения применяются в реальном времени, что позволяет интерактивно наблюдать результат и адаптировать карту под нужды конкретной текстуры. Полученная карта нормалей автоматически сохраняется в памяти и используется далее при визуализации.
	\item Модуль визуализации предоставляет пользователю два режима анализа результатов: 2D-визуализацию и 3D-визуализацию.
	\begin{itemize}
		\item В 2D-режиме используется техника имитации направленного света («фонарика»), управляемого движением курсора мыши. На основе нормалей рассчитывается освещённость каждой точки изображения, учитывая интенсивность и радиус света, а также уровень фоновой засветки. Таким образом создаётся реалистичный эффект освещения, позволяющий оценить, как текстура будет выглядеть в игровых сценах.
		\item В 3D-режиме карта нормалей и текстура проецируются на все шесть граней виртуального куба, который визуализируется с использованием OpenGL посредством GLCubeWidget. Пользователь может вращать куб мышью, изменяя ракурс наблюдения, и наблюдать взаимодействие нормалей с направленным освещением. Параметры света остаются настраиваемыми — интенсивность, радиус действия и рассеянность. Это расширяет возможности анализа и делает приложение более гибким в применении к задачам геймдизайна и графического моделирования.
	\end{itemize}
\end{enumerate}

Поддержка как 2D-, так и 3D-визуализации позволяет пользователю выбирать наиболее подходящий способ анализа текстуры в зависимости от задачи: от быстрой проверки нормалей в плоскости — до полноценного пространственного анализа поведения света. Такое архитектурное разделение обеспечивает гибкость, модульность и расширяемость приложения.

Графический интерфейс реализован с использованием библиотеки PyQt5 и спроектирован с учётом требований к удобству пользователя \cite{prokhorenok2021}. Все элементы интерфейса размещены логично: процесс работы разбит на этапы (загрузка изображения, генерация нормалей, визуализация), элементы управления параметрами имеют понятные подписи и расположение, соответствующее разработанному макету \cite{cooper2020}.

Таким образом, организационная модель решения задачи опирается на три ключевых принципа:
\begin{enumerate}
	\item Интерактивность — быстрый отклик на действия пользователя и визуальная обратная связь.
	\item Модульность — разделение системы на независимые логические блоки.
	\item Гибкость — возможность настройки алгоритмов и параметров под конкретные задачи.
\end{enumerate}
\subsection{Обоснование выбора технологий проектирования}

При разработке программно-информационной системы создания карт нормалей и их визуализации был проведён анализ различных языков программирования и программных библиотек, применимых для решения задач в области компьютерной графики, обработки изображений и создания пользовательского интерфейса. В результате был выбран стек технологий, оптимально сочетающий простоту разработки, функциональные возможности и широкую поддержку со стороны сообщества.
\subsubsection{Язык программирования: Python}

Python был выбран в качестве основного языка разработки по следующим причинам:
\begin{enumerate}
	\item Простота синтаксиса и высокая читаемость кода — это позволяет быстро реализовывать алгоритмы, минимизируя вероятность ошибок и снижая порог входа для других разработчиков \cite{ravichandiran2020}.
	\item Большое количество библиотек для работы с изображениями и интерфейсом — Python активно используется в научной и прикладной разработке в области компьютерного зрения.
	\item Кроссплатформенность — Python-приложения можно запускать под различными операционными системами, включая Windows, Linux и macOS.
	\item Активное сообщество и широкая документация — в случае возникновения проблем легко найти решение или получить помощь.
\end{enumerate}
\subsubsection{PyQt5}

PyQt5 — библиотека для создания графического интерфейса. Для реализации графического интерфейса была выбрана библиотека PyQt5 — привязка Python к мощному C++ фреймворку Qt \cite{talipov2020}. Основные причины выбора:
\begin{enumerate}
	\item Поддержка широкого спектра элементов интерфейса: кнопки, панели, слайдеры, вкладки и другие виджеты.
	\item Гибкая настройка расположения элементов — реализована возможность построения интерфейсов, соответствующих пользовательским макетам.
	\item Событийно-ориентированная модель — облегчает обработку пользовательских взаимодействий (например, загрузка изображений, перемещение мыши).
	\item Интеграция с другими библиотеками Python — PyQt5 хорошо работает в связке с NumPy, OpenCV и другими модулями.
\end{enumerate}
\subsubsection{OpenCV и NumPy}

OpenCV и NumPy — библиотеки для обработки изображений. Для обработки изображений и реализации операторов градиентного анализа были использованы библиотеки:
\begin{enumerate}
	\item OpenCV — открытая библиотека для обработки изображений и компьютерного зрения \cite{kaehler2021}. Обеспечивает эффективную реализацию операторов Sobel, Scharr и Prewitt, а также позволяет выполнять фильтрацию, преобразования, нормализацию и другие операции.
	\item NumPy — библиотека для работы с многомерными массивами и матрицами. Активно используется для хранения изображений в числовом формате, выполнения математических операций над данными пикселей и ускорения вычислений.
\end{enumerate}
\subsubsection{Pillow}

Pillow — библиотека для загрузки и сохранения изображений. Для работы с форматами изображений (PNG, JPG и др.) используется библиотека Pillow, являющаяся модернизированной и расширенной версией PIL (Python Imaging Library). Она позволяет:
\begin{enumerate}
	\item Загружать изображения из файлов.
	\item Конвертировать изображения между различными цветовыми пространствами.
	\item Сохранять результаты генерации нормалей в различных форматах.
	\item Извлекать метаинформацию об изображениях.
\end{enumerate}

OpenGL — библиотека для трёхмерной графики и визуализации.
С использованием OpenGL реализованы следующие возможности:
\begin{enumerate}
	\item Создание 3D-сцены с кубом, каждая грань которого текстурирована загруженным изображением.
	\item Назначение карты нормалей в качестве источника данных для расчёта взаимодействия поверхности с направленным освещением.
	\item Обработка пользовательского ввода (вращение, масштабирование сцены).
	\item Моделирование поведения направленного источника света и реалистичного освещения с учётом нормалей.
\end{enumerate}

Для отображения визуального эффекта освещения по нормалям применяется рендеринг на холст с использованием комбинации данных карты нормалей и положения мыши. Алгоритм реализован вручную с использованием NumPy и PyQt5, без сторонних движков визуализации, что обеспечивает наглядность и полный контроль над процессом.

Таким образом, выбор данных технологий обусловлен их доступностью, функциональностью, хорошей документацией, а также возможностью их свободного использования в учебных и исследовательских целях. Это позволило сосредоточиться на реализации ключевых функций программы без необходимости разработки низкоуровневых инструментов "с нуля".
\subsection{Общая архитектура системы}

Программно-информационная система генерации карт нормалей и их интерактивной визуализации построена по модульному принципу. Это обеспечивает высокую модульность, возможность масштабирования и упрощает сопровождение и тестирование. Приложение реализовано как настольное, с графическим интерфейсом на языке Python. Система поддерживает два режима визуализации: в 2D с имитацией освещения и в 3D с использованием OpenGL.

Диаграмма компонентов представлена на рисунке~\ref{comp2:image}.

\begin{figure}[ht]
	\includegraphics[width=1\linewidth]{comp2}
	\caption{Диаграмма компонентов программной системы}
	\label{comp2:image}
\end{figure}

Основные модули системы:

\begin{enumerate}
	\item Интерфейсный и логический модуль — файл ui.py.
	\item Модуль генерации карты нормалей — файл normal\_map.py.
	\item Модуль визуализации в 3D — файл glcube.py.
	\item Точка входа в приложение — файл main.py.
\end{enumerate}

\subsubsection{Интерфейсный и логический модуль (ui.py)}

Этот модуль содержит основную логику работы программы и формирует графический интерфейс при помощи библиотеки PyQt5. В нём реализованы:

\begin{enumerate}
	\item Загрузка изображения (PNG, JPEG, BMP) через диалог выбора файла.
	\item Управление параметрами генерации карты нормалей: выбор оператора (Sobel, Scharr, Prewitt), сила, глубина, инверсия.
	\item Отображение оригинального изображения и сгенерированной карты нормалей.
	\item Визуализация эффекта освещения в 2D режиме — поведение источника света ("фонарика") следует за движением курсора.
	\item Отображение изображения с освещением в реальном времени.
	\item Переключение между 2D и 3D режимами.
	\item Сохранение сгенерированной карты нормалей.
\end{enumerate}

Все взаимодействия с пользователем происходят именно в этом модуле: действия передаются в модуль генерации нормалей или в OpenGL-виджет.

\subsubsection{Модуль генерации нормалей (normal\_map.py)}

Этот модуль отвечает за построение карты нормалей по загруженному изображению. Он реализует несколько алгоритмов градиентного анализа:

\begin{enumerate}
	\item Sobel — оператор для вычисления производных первого порядка.
	\item Scharr — оператор с повышенной точностью на границах.
	\item Prewitt — простой оператор с фиксированными масками.
\end{enumerate}

Пользователь может регулировать параметры генерации:
\begin{itemize}
	\item сила нормалей — масштаб по осям X и Y;
	\item гладкость — влияние по оси Z;
	\item инверсия нормалей — изменение направления векторов.
\end{itemize}

Выходным результатом является изображение, в котором каждый пиксель содержит нормаль в виде вектора, закодированного в цветовых каналах RGB.

\subsubsection{Модуль визуализации в 3D (glcube.py)}

Этот модуль реализован с использованием QOpenGLWidget и библиотеки PyOpenGL. Он отвечает за визуализацию карты нормалей на вращающемся кубе. Функциональность включает:

\begin{enumerate}
	\item Преобразование изображения и карты нормалей в текстуры OpenGL.
	\item Отображение текстурированных граней куба.
	\item Поддержка управления освещением и положением источника света.
	\item Управление вращением куба и масштабированием с помощью мыши.
	\item Имитация взаимодействия света с нормалями.
\end{enumerate}

Этот режим позволяет пользователю оценить результат генерации в трёхмерном виде, что полезно при разработке игровых текстур.

\subsubsection{Точка входа (main.py)}

Файл main.py содержит минимальный код — он импортирует основной класс приложения из ui.py и запускает его. Его задача — инициализировать интерфейс и передать управление системе.
\subsection{Реализация модуля генерации карт нормалей}

Модуль генерации карт нормалей представляет собой ключевую компоненту программной системы, предназначенную для преобразования обычного двухмерного изображения в нормал-карту — трёхканальное изображение, содержащее информацию о направлении нормалей к виртуальной поверхности. Это позволяет имитировать рельефность изображения без использования дополнительных геометрических деталей \cite{russ2020}.

Процесс генерации карты нормалей состоит из нескольких последовательных этапов.

На первом этапе входное изображение преобразуется в оттенки серого. Это необходимо для упрощения дальнейшего анализа, поскольку данные о цвете не участвуют в расчётах нормалей. Затем изображение конвертируется в числовой массив, содержащий значения яркости каждого пикселя.

Далее производится вычисление градиентов изображения — то есть изменений яркости по горизонтали и вертикали. Для этого применяется один из операторов свёртки: Sobel, Scharr или Prewitt. Пользователь может выбрать нужный оператор через интерфейс. Эти операторы позволяют определить, насколько сильно и в каком направлении изменяется яркость изображения в каждой точке. Это изменение отражает структуру "высот" изображения, которую можно трактовать как рельеф.

Полученные горизонтальные и вертикальные градиенты масштабируются в соответствии с заданным пользователем параметром силы нормали. Чем выше значение силы, тем контрастнее будет рельеф на итоговой карте нормалей.

Третья компонента нормали, направленная перпендикулярно изображению (в глубину), задаётся как фиксированное значение, также масштабируемое по параметру глубины. Далее на основе трёх компонентов (по осям X, Y и Z) формируется вектор нормали. Все векторы нормализуются, то есть приводятся к единичной длине, чтобы сохранить корректность направлений.

При необходимости пользователь может включить параметр инверсии, при котором направление векторов нормалей меняется на противоположное. Это может быть полезно для корректной работы с различными движками визуализации, ожидающими ту или иную ориентацию нормалей.

В завершение формируется итоговая нормал-карта. Она состоит из трёх каналов, соответствующих осям X, Y и Z, и преобразуется в формат, пригодный для отображения и сохранения (все значения нормалей переводятся из диапазона [-1; 1] в [0; 1]). Итоговое изображение возвращается в виде массива и может быть использовано в визуализации или сохранено на диск.

Таким образом, реализованный модуль генерации карт нормалей позволяет на основе 2D-изображения создавать полноценную нормал-карту, пригодную для последующего освещения и анализа микрорельефа. Применение градиентных операторов в сочетании с настраиваемыми параметрами обеспечивает гибкость и точность работы алгоритма.
\subsection{Реализация модуля визуализации освещения}

Модуль визуализации освещения предназначен для отображения результатов генерации карты нормалей с учётом воздействия направленного источника света. В системе реализованы два режима визуализации: 2D-режим, где эффект освещения имитируется на плоской текстуре, и 3D-режим, в котором карта нормалей применяется на грани трёхмерного куба.
\subsubsection{2D-визуализация}

После загрузки изображения и генерации карты нормалей система автоматически визуализирует результат на основе положения курсора мыши, выполняющего роль направленного источника света. Освещённость пересчитывается в реальном времени при каждом движении мыши.

Алгоритм работы следующий:
\begin{enumerate}
	\item Пользователь перемещает курсор над областью изображения.
	\item Программа фиксирует координаты мыши как положение источника света.
	\item Для каждой точки изображения рассчитывается вектор от пикселя к источнику света.
	\item Система нормализует вектор направления света и нормаль из карты.
	\item Вычисляется скалярное произведение между нормалью и вектором света.
	\item Полученное значение модифицируется с учётом: радиуса действия света, фоновой освещённости, интенсивности света.
	\item Яркость каждого пикселя обновляется в соответствии с результатами расчёта.
	\item Обновлённое изображение отображается в интерфейсе.
\end{enumerate}
\subsubsection{3D-визуализация}

В 3D-режиме карта нормалей применяется к поверхности куба, визуализируемого при помощи OpenGL. Каждая грань отображает исходное изображение с имитацией объёмности за счёт световых эффектов.

Алгоритм работы 3D-режима:
\begin{enumerate}
	\item После переключения в режим 3D запускается компонент QOpenGLWidget.
	\item Выполняется инициализация сцены и загрузка текстур.
	\item Куб отображается на экране с наложением изображения и нормалей.
	\item Пользователь может вращать куб мышью, меняя угол обзора.
	\item Источник света фиксирован в сцене и направлен в центр объекта.
	\item Для каждой вершины и фрагмента куба применяется освещение на основе нормалей.
	\item Освещение рассчитывается с использованием OpenGL, включая нормализацию, модель Ламберта и затухание.
	\item Сцена обновляется в реальном времени.
\end{enumerate}

Таким образом, 3D-визуализация позволяет более наглядно оценить, как карта нормалей влияет на восприятие текстуры в объёмном пространстве.

Обе визуализации позволяют пользователю анализировать результат генерации нормалей в интерактивном режиме. 2D-режим удобен для быстрой оценки освещённости на плоскости, а 3D — для демонстрации объёмного эффекта и тестирования результата в условиях, приближенных к игровым сценам.
\subsection{Структура пользовательского интерфейса}

На основании требований к пользовательскому интерфейсу [19], представленных в пункте 2.3.2.1 технического задания, был разработан графический интерфейс приложения. Интерфейс реализован с использованием библиотеки PyQt5, которая позволяет создать графическое приложение с гибкой системой компоновки элементов и поддержкой событий.

Интерфейс программы представлен на рисунке ~\ref{interf2:image}.

\begin{figure}[ht]
	\includegraphics[width=1\linewidth]{interf2}
	\caption{Интерфейс программы}
	\label{interf2:image}
\end{figure}

Элементы интерфейса:
\begin{enumerate}
	\item Окно оригинального изображения. Отображает исходное изображение, загруженное пользователем для генерации карты нормалей.
	\item Кнопка "Загрузить". Открывает диалоговое окно выбора изображения, которое будет использоваться для анализа и генерации нормалей.	
	\item Окно карты нормалей. Показывает сгенерированную карту нормалей на основе оригинального изображения и выбранных параметров.
	\item  Кнопка "Сохранить". Сохраняет сгенерированную карту нормалей в выбранное пользователем место.
	\item Ползунок "Сила нормалей". Регулирует интенсивность/амплитуду нормалей. Чем выше значение, тем рельефнее выглядит результат.
	\item Ползунок "Гладкость". Активирует дополнительное влияние глубины на расчет нормалей (если предусмотрена соответствующая логика в коде).
	\item Выпадающий список "Оператор". Позволяет выбрать математический оператор, применяемый для выделения границ (например, Собель, Шарра и др.).
	\item Чекбокс "Инвертировать". При включении инвертирует направление нормалей, меняя визуальное восприятие рельефа.
	\item Выпадающий список "Режим". Позволяет выбрать режим отображения визуализации (2D и 3D).	
	\item Ползунок "Интенсивность". Управляет яркостью источника света при визуализации эффекта освещения.
	\item Ползунок "Окружение". Добавляет равномерное базовое освещение всей сцены для повышения читаемости изображения.
	\item  Ползунок "Радиус". Определяет зону, охватываемую виртуальным "фонариком". Чем больше значение, тем шире область освещённости.
	\item Окно визуализации. Показывает изображение с наложенной картой нормалей, в котором курсор мыши используется как источник света для динамического освещения по карте нормалей.
\end{enumerate}
